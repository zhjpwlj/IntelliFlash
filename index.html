<!DOCTYPE html>
<html lang="zh-CN" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能闪卡 (IntelliFlash) - Gemini AI 版</title>
    <meta name="description" content="一个集成了间隔重复、多种学习模式和社区共享的强大闪卡应用。由 Gemini AI 驱动。">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4A90E2/FFFFFF?text=IF">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        /* 仅保留无冲突的动画和基础样式 */
        .card {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        .srs-btn-again { background-color: #EF5350; }
        .srs-btn-hard { background-color: #FFA726; }
        .srs-btn-good { background-color: #66BB6A; }
        .srs-btn-easy { background-color: #29B6F6; }

        .match-item.selected {
            border-color: #4A90E2;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
        }
        .match-item.matched {
            border-color: #66BB6A;
            background-color: #e8f5e9;
            color: #2e7d32;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s;
        }
        .dark .match-item.matched {
             background-color: #2d3748;
             color: #66BB6A;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-content {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-300">

    <!-- 全局加载指示器 -->
    <div id="global-loader" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="loader"></div>
    </div>
    
    <!-- 全局通知 -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- 主容器 -->
    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- 导航栏 -->
        <nav class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                <i class="fas fa-brain mr-2"></i>IntelliFlash
            </h1>
            <div>
                <button id="theme-toggle" class="mr-4 text-xl"><i class="fas fa-moon"></i></button>
                <div id="user-info" class="hidden inline-block">
                    <span id="user-email" class="mr-4"></span>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">登出</button>
                </div>
                <div id="auth-buttons" class="inline-block">
                    <button id="login-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">登录</button>
                </div>
            </div>
        </nav>

        <!-- 主页面 -->
        <main id="main-page">
            <div class="my-6 text-center">
                <button id="create-set-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    <i class="fas fa-plus mr-2"></i>创建新卡组
                </button>
                 <button id="public-library-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg text-lg ml-4">
                    <i class="fas fa-globe mr-2"></i>公开卡组库
                </button>
            </div>
            <section id="my-sets-section">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">我的卡组</h2>
                <div id="sets-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 卡组卡片将在这里动态生成 -->
                </div>
            </section>
        </main>
        
        <!-- 公开卡组库页面 -->
        <main id="public-library-page" class="hidden">
            <div class="my-6 flex justify-between items-center">
                 <h2 class="text-2xl font-semibold">公开卡组库</h2>
                 <button id="back-to-my-sets-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>返回我的卡组
                </button>
            </div>
            <div class="mb-4">
                <input type="text" id="public-search-input" placeholder="搜索公开卡组..." class="w-full p-3 rounded-lg border bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600">
            </div>
            <div id="public-sets-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>

        <!-- 学习页面 -->
        <div id="study-page" class="hidden"></div>
        
        <!-- 统计页面 -->
        <div id="stats-page" class="hidden p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">学习统计</h2>
                <button id="back-to-main-from-stats" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>返回
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative h-64"><canvas id="srs-status-chart"></canvas></div>
                <div class="relative h-64"><canvas id="review-activity-chart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- 登录/注册模态框 -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-40">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md relative">
            <button id="close-auth-modal" class="absolute top-4 right-4 text-2xl text-gray-600 dark:text-gray-400 hover:text-black dark:hover:text-white">&times;</button>
            <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-center">登录</h2>
            <form id="email-password-form" onsubmit="return false;">
                <input type="email" id="email-input" placeholder="邮箱" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                <input type="password" id="password-input" placeholder="密码 (至少6位)" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                <button type="button" id="email-login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded mb-2">登录</button>
                <button type="button" id="email-register-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded">注册</button>
            </form>
            <div class="my-4 text-center text-gray-500">或</div>
            <button id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded flex items-center justify-center shadow-sm hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 dark:border-gray-600">
                <img src="https://www.google.com/favicon.ico" alt="Google" class="w-6 h-6 mr-3">
                使用 Google 登录
            </button>
        </div>
    </div>

    <!-- 创建/编辑卡组模态框 -->
    <div id="set-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-40">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col">
            <h2 id="set-modal-title" class="text-2xl font-bold mb-4">创建新卡组</h2>
            <form id="set-form" class="flex flex-col flex-grow min-h-0">
                <!-- Static Top Part -->
                <div>
                    <input type="hidden" id="set-id-input">
                    <input type="text" id="set-title-input" placeholder="卡组标题，例如“高频英语词汇”" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                    <textarea id="set-description-input" placeholder="卡组描述" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600" rows="2"></textarea>
                    <div class="flex items-center mb-4">
                        <label for="set-public-checkbox" class="mr-2">公开分享此卡组:</label>
                        <input type="checkbox" id="set-public-checkbox" class="h-5 w-5">
                    </div>
                    <div class="bg-blue-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold mb-2 text-lg text-blue-800 dark:text-blue-300">✨ AI 智能生成卡片</h3>
                        <div class="flex gap-2">
                            <input type="text" id="ai-topic-input" placeholder="输入主题，如“太阳系行星”" class="w-full p-2 border rounded bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500">
                            <button type="button" id="ai-generate-cards-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded whitespace-nowrap">生成卡片</button>
                        </div>
                    </div>
                    <h3 class="font-semibold mb-2">卡片</h3>
                </div>
                <!-- Scrollable Middle Part -->
                <div id="cards-container" class="flex-grow overflow-y-auto pr-2 min-h-0">
                    <!-- 卡片输入框将在这里动态生成 -->
                </div>
                <!-- Static Bottom Part -->
                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" id="add-card-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-plus mr-2"></i>添加卡片
                    </button>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="cancel-set-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-4">取消</button>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">保存卡组</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, 
            deleteDoc, query, where, writeBatch, getDoc, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ===================================================================================
        // 🔥 配置 (重要!)
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDyYXFukIb4R16o8mx7cl9ZUzsCO6Y6fro",
            authDomain: "intelliflash-6574c.firebaseapp.com",
            projectId: "intelliflash-6574c",
            storageBucket: "intelliflash-6574c.firebasestorage.app",
            messagingSenderId: "730575240954",
            appId: "1:730575240954:web:d2771d613441f4731cd343",
            measurementId: "G-XFP1RE80XN"
        };
        
        const GEMINI_API_KEY = "AIzaSyB4kejtqBehPI0Ri1e_huC35-7Gkw7dszk"; // 留空即可，Canvas 会自动提供
        
        // ===================================================================================
        // 初始化 Firebase
        // ===================================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;
        let srsStatusChart = null;
        let reviewActivityChart = null;

        // ===================================================================================
        // 全局状态和 DOM 元素
        // ===================================================================================
        const globalLoader = document.getElementById('global-loader');
        const mainPage = document.getElementById('main-page');
        const studyPage = document.getElementById('study-page');
        const statsPage = document.getElementById('stats-page');
        const publicLibraryPage = document.getElementById('public-library-page');
        const setsContainer = document.getElementById('sets-container');
        const publicSetsContainer = document.getElementById('public-sets-container');
        const toast = document.getElementById('toast-notification');
        
        // ===================================================================================
        // 工具函数
        // ===================================================================================
        const showLoader = () => globalLoader.classList.remove('hidden');
        const hideLoader = () => globalLoader.classList.add('hidden');

        function showToast(message, isError = false) {
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 3000);
        }
        
        // ===================================================================================
        // 主题切换
        // ===================================================================================
        const themeToggle = document.getElementById('theme-toggle');
        const htmlEl = document.documentElement;

        function updateTheme(isDark) {
            htmlEl.classList.toggle('dark', isDark);
            themeToggle.querySelector('i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        themeToggle.addEventListener('click', () => {
            updateTheme(!htmlEl.classList.contains('dark'));
        });

        function applyInitialTheme() {
            const storedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            updateTheme(storedTheme === 'dark' || (storedTheme === null && systemPrefersDark));
        }
        
        applyInitialTheme();

        // ===================================================================================
        // 认证逻辑
        // ===================================================================================
        const authModal = document.getElementById('auth-modal');
        const loginModalBtn = document.getElementById('login-modal-btn');
        const closeAuthModalBtn = document.getElementById('close-auth-modal');
        const authButtons = document.getElementById('auth-buttons');
        const userInfo = document.getElementById('user-info');
        
        loginModalBtn.addEventListener('click', () => authModal.classList.remove('hidden'));
        closeAuthModalBtn.addEventListener('click', () => authModal.classList.add('hidden'));
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.displayName || user.email;
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                authModal.classList.add('hidden');
                loadUserSets();
                initNotifications();
            } else {
                currentUser = null;
                document.getElementById('user-email').textContent = '';
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                setsContainer.innerHTML = '<p class="text-center col-span-full">请先登录以查看或创建卡组。</p>';
            }
        });

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showToast('登录成功！');
            } catch (error) {
                console.error("Google 登录失败:", error);
                showToast(`登录失败: ${error.message}`, true);
            }
        });

        document.getElementById('email-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) return;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('登录成功！');
            } catch (error) {
                console.error("邮箱登录失败:", error);
                showToast(`登录失败: ${error.message}`, true);
            }
        });

        document.getElementById('email-register-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            if (!email || !password) return;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('注册成功，已自动登录！');
            } catch (error) {
                console.error("注册失败:", error);
                showToast(`注册失败: ${error.message}`, true);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('已成功登出。');
                mainPage.classList.remove('hidden');
                studyPage.classList.add('hidden');
                statsPage.classList.add('hidden');
                publicLibraryPage.classList.add('hidden');
            } catch (error) {
                console.error("登出失败:", error);
                showToast(`登出失败: ${error.message}`, true);
            }
        });
        
        // ===================================================================================
        // Gemini API 调用
        // ===================================================================================
        async function callGemini(prompt, jsonSchema = null) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                throw new Error("Gemini API 密钥未配置。");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema,
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API 请求失败: ${errorBody?.error?.message || response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("API 返回了无效的响应格式");
                return text;
            } catch (error) {
                console.error("调用 Gemini API 时出错:", error);
                throw error;
            }
        }

        // ===================================================================================
        // 卡组 CRUD 逻辑
        // ===================================================================================
        const setModal = document.getElementById('set-modal');
        const createSetBtn = document.getElementById('create-set-btn');
        const cancelSetBtn = document.getElementById('cancel-set-btn');
        const addCardBtn = document.getElementById('add-card-btn');
        const setForm = document.getElementById('set-form');
        const cardsContainer = document.getElementById('cards-container');
        const aiGenerateBtn = document.getElementById('ai-generate-cards-btn');

        createSetBtn.addEventListener('click', () => openSetModal());
        cancelSetBtn.addEventListener('click', () => setModal.classList.add('hidden'));

        function openSetModal(set = null) {
            setForm.reset();
            document.getElementById('set-id-input').value = set ? set.id : '';
            document.getElementById('set-modal-title').textContent = set ? '编辑卡组' : '创建新卡组';
            document.getElementById('set-title-input').value = set ? set.title : '';
            document.getElementById('set-description-input').value = set ? set.description : '';
            document.getElementById('set-public-checkbox').checked = set ? set.isPublic : false;
            
            cardsContainer.innerHTML = '';
            if (set && set.cards) {
                set.cards.forEach(card => addCardInputs(card));
            } else {
                addCardInputs();
            }
            setModal.classList.remove('hidden');
        }

        addCardBtn.addEventListener('click', () => addCardInputs());
        
        aiGenerateBtn.addEventListener('click', async () => {
            const topic = document.getElementById('ai-topic-input').value;
            if (!topic) {
                showToast('请输入一个主题！', true);
                return;
            }
            
            showLoader();
            try {
                const prompt = `为以下主题生成一个包含10个术语和定义的闪卡列表：'${topic}'。请确保术语和定义简洁明了，适合制作成闪卡。`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        cards: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    term: { type: "STRING" },
                                    definition: { type: "STRING" }
                                },
                                required: ["term", "definition"]
                            }
                        }
                    },
                    required: ["cards"]
                };

                const jsonString = await callGemini(prompt, schema);
                const generatedData = JSON.parse(jsonString);

                if (generatedData.cards && generatedData.cards.length > 0) {
                    if (cardsContainer.children.length === 1 && 
                        !cardsContainer.querySelector('.term-input').value && 
                        !cardsContainer.querySelector('.definition-input').value) {
                        cardsContainer.innerHTML = '';
                    }
                    generatedData.cards.forEach(card => addCardInputs(card));
                    showToast('AI 已成功生成卡片！');
                } else {
                    showToast('AI 未能生成卡片，请尝试更换主题。', true);
                }

            } catch (error) {
                showToast(`AI 生成失败: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        });

        function addCardInputs(card = {}) {
            const cardId = card.id || `new_${Date.now()}_${Math.random()}`;
            const cardDiv = document.createElement('div');
            cardDiv.className = 'grid grid-cols-12 gap-2 mb-3 items-center card-input-group';
            cardDiv.dataset.cardId = cardId;
            
            cardDiv.innerHTML = `
                <div class="col-span-5">
                    <textarea placeholder="正面" class="w-full p-2 border rounded bg-gray-100 dark:bg-gray-600 term-input" rows="2">${card.term || ''}</textarea>
                </div>
                <div class="col-span-5">
                    <textarea placeholder="背面" class="w-full p-2 border rounded bg-gray-100 dark:bg-gray-600 definition-input" rows="2">${card.definition || ''}</textarea>
                </div>
                <div class="col-span-2 flex items-center justify-around">
                    <label for="image-upload-${cardId}" class="cursor-pointer text-blue-500 hover:text-blue-700">
                        <i class="fas fa-image"></i>
                    </label>
                    <input type="file" id="image-upload-${cardId}" class="hidden image-upload-input" accept="image/*">
                    <img src="${card.imageUrl || ''}" class="w-8 h-8 object-cover ${card.imageUrl ? '' : 'hidden'} image-preview">
                    <button type="button" class="text-red-500 hover:text-red-700 remove-card-btn"><i class="fas fa-trash"></i></button>
                </div>
            `;
            cardsContainer.appendChild(cardDiv);

            cardDiv.querySelector('.remove-card-btn').addEventListener('click', () => cardDiv.remove());
            cardDiv.querySelector('.image-upload-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const preview = cardDiv.querySelector('.image-preview');
                    preview.src = URL.createObjectURL(file);
                    preview.classList.remove('hidden');
                }
            });
        }

        setForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showToast('请先登录', true);
                return;
            }
            showLoader();

            const setId = document.getElementById('set-id-input').value;
            const setData = {
                title: document.getElementById('set-title-input').value,
                description: document.getElementById('set-description-input').value,
                isPublic: document.getElementById('set-public-checkbox').checked,
                ownerId: currentUser.uid,
                ownerName: currentUser.displayName || currentUser.email,
                updatedAt: serverTimestamp(),
            };

            try {
                let savedSetId = setId;
                if (setId) {
                    const setRef = doc(db, 'sets', setId);
                    await updateDoc(setRef, setData);
                } else {
                    const docRef = await addDoc(collection(db, 'sets'), { ...setData, createdAt: serverTimestamp() });
                    savedSetId = docRef.id;
                }

                const cardInputGroups = cardsContainer.querySelectorAll('.card-input-group');
                const batch = writeBatch(db);
                
                for (const group of cardInputGroups) {
                    const term = group.querySelector('.term-input').value;
                    const definition = group.querySelector('.definition-input').value;
                    if (!term || !definition) continue;
                    
                    const cardId = group.dataset.cardId;
                    const isNewCard = cardId.startsWith('new_');
                    
                    const cardRef = isNewCard
                        ? doc(collection(db, `sets/${savedSetId}/cards`))
                        : doc(db, `sets/${savedSetId}/cards`, cardId);
                    
                    const cardData = { term, definition };
                    if (isNewCard) {
                        Object.assign(cardData, {
                            easeFactor: 2.5,
                            interval: 0,
                            repetitions: 0,
                            nextReview: new Date()
                        });
                    }

                    const imageInput = group.querySelector('.image-upload-input');
                    const imageFile = imageInput.files[0];
                    if (imageFile) {
                        const imageRef = ref(storage, `card-images/${currentUser.uid}/${savedSetId}/${Date.now()}_${imageFile.name}`);
                        const snapshot = await uploadBytes(imageRef, imageFile);
                        cardData.imageUrl = await getDownloadURL(snapshot.ref);
                    } else {
                        cardData.imageUrl = group.querySelector('.image-preview').src || '';
                    }

                    batch.set(cardRef, cardData, { merge: true });
                }
                
                await batch.commit();
                showToast(`卡组已${setId ? '更新' : '创建'}！`);
                setModal.classList.add('hidden');
                loadUserSets();
            } catch (error) {
                console.error("保存卡组失败:", error);
                showToast(`操作失败: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        });

        async function deleteSet(setId) {
            if (!confirm('确定要删除这个卡组吗？所有相关的卡片和学习进度都将被永久删除。')) return;
            showLoader();
            try {
                // In a real app, you'd also delete subcollections and storage files.
                await deleteDoc(doc(db, 'sets', setId));
                showToast('卡组已删除。');
                loadUserSets();
            } catch (error) {
                console.error("删除卡组失败:", error);
                showToast(`删除失败: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        async function loadUserSets() {
            if (!currentUser) return;
            showLoader();
            try {
                const q = query(collection(db, 'sets'), where("ownerId", "==", currentUser.uid));
                const querySnapshot = await getDocs(q);
                setsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    setsContainer.innerHTML = '<p class="text-center col-span-full">你还没有创建任何卡组。点击上方按钮开始吧！</p>';
                } else {
                    for (const docSnap of querySnapshot.docs) {
                        const set = { id: docSnap.id, ...docSnap.data() };
                        const cardsSnapshot = await getDocs(collection(db, `sets/${set.id}/cards`));
                        set.cardCount = cardsSnapshot.size;
                        setsContainer.appendChild(createSetCard(set));
                    }
                }
            } catch (error) {
                console.error("加载卡组失败:", error);
                showToast('加载你的卡组时出错。请检查控制台获取详情。', true);
            } finally {
                hideLoader();
            }
        }

        function createSetCard(set, isPublic = false) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex flex-col justify-between';
            
            let buttonsHtml = '';
            if (isPublic) {
                buttonsHtml = `<button class="clone-set-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full"><i class="fas fa-clone mr-2"></i>克隆到我的卡组</button>`;
            } else {
                buttonsHtml = `
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button class="study-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"><i class="fas fa-book-open mr-2"></i>学习</button>
                        <button class="stats-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded"><i class="fas fa-chart-line mr-2"></i>统计</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                         <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded"><i class="fas fa-edit mr-2"></i>编辑</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"><i class="fas fa-trash mr-2"></i>删除</button>
                    </div>`;
            }

            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-2">${set.title}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">${set.description || '没有描述'}</p>
                    <p class="text-sm text-gray-500">${set.cardCount || 0} 张卡片</p>
                    ${isPublic ? `<p class="text-sm text-gray-500 mt-1">创建者: ${set.ownerName || '匿名'}</p>` : ''}
                </div>
                <div class="mt-4">${buttonsHtml}</div>`;

            if (isPublic) {
                card.querySelector('.clone-set-btn').addEventListener('click', () => cloneSet(set.id));
            } else {
                card.querySelector('.study-btn').addEventListener('click', () => startStudy(set.id));
                card.querySelector('.stats-btn').addEventListener('click', () => showStatsPage(set.id));
                card.querySelector('.edit-btn').addEventListener('click', async () => {
                    showLoader();
                    const cardsSnapshot = await getDocs(collection(db, `sets/${set.id}/cards`));
                    const cards = cardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    hideLoader();
                    openSetModal({ ...set, cards });
                });
                card.querySelector('.delete-btn').addEventListener('click', () => deleteSet(set.id));
            }
            return card;
        }
        
        // ===================================================================================
        // 公开卡组库逻辑
        // ===================================================================================
        document.getElementById('public-library-btn').addEventListener('click', () => {
            mainPage.classList.add('hidden');
            publicLibraryPage.classList.remove('hidden');
            loadPublicSets();
        });
        
        document.getElementById('back-to-my-sets-btn').addEventListener('click', () => {
            mainPage.classList.remove('hidden');
            publicLibraryPage.classList.add('hidden');
        });
        
        let allPublicSets = [];
        async function loadPublicSets() {
            if (!currentUser) {
                publicSetsContainer.innerHTML = '<p class="text-center col-span-full">请先登录以浏览公开卡组库。</p>';
                return;
            }
            showLoader();
            try {
                const q = query(collection(db, 'sets'), where("isPublic", "==", true));
                const querySnapshot = await getDocs(q);
                allPublicSets = [];
                for (const docSnap of querySnapshot.docs) {
                    const set = { id: docSnap.id, ...docSnap.data() };
                    if (set.ownerId === currentUser.uid) continue;
                    
                    const cardsSnapshot = await getDocs(collection(db, `sets/${set.id}/cards`));
                    set.cardCount = cardsSnapshot.size;
                    allPublicSets.push(set);
                }
                displayPublicSets(allPublicSets);
            } catch (error) {
                console.error("加载公开卡组失败:", error);
                showToast('加载公开卡组失败', true);
            } finally {
                hideLoader();
            }
        }
        
        function displayPublicSets(sets) {
             publicSetsContainer.innerHTML = '';
             if (sets.length === 0) {
                publicSetsContainer.innerHTML = '<p class="text-center col-span-full">目前没有公开的卡组。</p>';
                return;
            }
            sets.forEach(set => {
                publicSetsContainer.appendChild(createSetCard(set, true));
            });
        }
        
        document.getElementById('public-search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredSets = allPublicSets.filter(set => 
                set.title.toLowerCase().includes(searchTerm) || 
                (set.description && set.description.toLowerCase().includes(searchTerm))
            );
            displayPublicSets(filteredSets);
        });
        
        async function cloneSet(setId) {
            if (!currentUser) {
                showToast('请先登录', true);
                return;
            }
            if (!confirm('确定要克隆这个卡组吗？它将被复制到“我的卡组”中。')) return;
            showLoader();
            try {
                const originalSetRef = doc(db, 'sets', setId);
                const originalSetSnap = await getDoc(originalSetRef);
                if (!originalSetSnap.exists()) throw new Error("原始卡组不存在");
                
                const originalSetData = originalSetSnap.data();
                const newSetRef = await addDoc(collection(db, 'sets'), {
                    title: originalSetData.title,
                    description: originalSetData.description,
                    isPublic: false,
                    ownerId: currentUser.uid,
                    ownerName: currentUser.displayName || currentUser.email,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    clonedFrom: setId,
                });

                const originalCardsSnap = await getDocs(collection(db, `sets/${setId}/cards`));
                const batch = writeBatch(db);
                originalCardsSnap.forEach(cardDoc => {
                    const newCardRef = doc(collection(db, `sets/${newSetRef.id}/cards`));
                    batch.set(newCardRef, cardDoc.data());
                });

                await batch.commit();
                showToast('卡组克隆成功！');
                loadUserSets();
            } catch (error) {
                console.error("克隆卡组失败:", error);
                showToast(`克隆失败: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        // ===================================================================================
        // 学习逻辑
        // ===================================================================================
        let currentSetCards = [];
        let currentCardIndex = 0;
        let currentSetId = null;
        let allCardsInCurrentSet = [];

        async function startStudy(setId) {
            showLoader();
            try {
                currentSetId = setId;
                const cardsSnapshot = await getDocs(collection(db, `sets/${setId}/cards`));
                allCardsInCurrentSet = cardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (allCardsInCurrentSet.length === 0) {
                    showToast('这个卡组里没有卡片！', true);
                    hideLoader();
                    return;
                }
                
                const now = new Date();
                const dueCards = allCardsInCurrentSet.filter(card => {
                    const nextReviewDate = card.nextReview?.toDate ? card.nextReview.toDate() : new Date(0);
                    return nextReviewDate <= now;
                });

                if (dueCards.length === 0) {
                     showToast('太棒了！今天没有需要复习的卡片。');
                     hideLoader();
                     return;
                }
                
                currentSetCards = shuffleArray(dueCards);
                currentCardIndex = 0;

                mainPage.classList.add('hidden');
                studyPage.classList.remove('hidden');
                showStudyModeSelection();

            } catch (error) {
                console.error("开始学习失败:", error);
                showToast(`开始学习失败: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        function showStudyModeSelection() {
            studyPage.innerHTML = `
                <div class="text-center p-8">
                    <h2 class="text-3xl font-bold mb-2">选择学习模式</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-8">今天有 ${currentSetCards.length} 张卡片需要复习。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                        <button data-mode="flashcard" class="study-mode-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-6 px-4 rounded-lg text-xl"><i class="fas fa-clone mr-3"></i>翻卡学习</button>
                        <button data-mode="spell" class="study-mode-btn bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-4 rounded-lg text-xl"><i class="fas fa-keyboard mr-3"></i>拼写</button>
                        <button data-mode="quiz" class="study-mode-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-6 px-4 rounded-lg text-xl"><i class="fas fa-question-circle mr-3"></i>✨ AI 增强测验</button>
                        <button data-mode="match" class="study-mode-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-6 px-4 rounded-lg text-xl"><i class="fas fa-gamepad mr-3"></i>匹配游戏</button>
                    </div>
                    <button id="back-to-main-from-study" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回</button>
                </div>`;
            document.querySelectorAll('.study-mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    switch(mode) {
                        case 'flashcard': renderFlashcardMode(); break;
                        case 'spell': renderSpellMode(); break;
                        case 'quiz': renderQuizMode(); break;
                        case 'match': renderMatchMode(); break;
                    }
                });
            });
            document.getElementById('back-to-main-from-study').addEventListener('click', backToMain);
        }
        
        function backToMain() {
            mainPage.classList.remove('hidden');
            studyPage.classList.add('hidden');
            statsPage.classList.add('hidden');
            publicLibraryPage.classList.add('hidden');
            loadUserSets();
        }

        function renderFlashcardMode() {
            currentCardIndex = 0;
            showFlashcard();
        }

        function showFlashcard() {
            if (currentCardIndex >= currentSetCards.length) {
                finishStudySession();
                return;
            }
            const card = currentSetCards[currentCardIndex];
            studyPage.innerHTML = `
                <div class="p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${currentCardIndex + 1} / ${currentSetCards.length}</p>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回模式选择</button>
                    </div>
                    <div id="flashcard-container" class="relative w-full h-80 perspective-1000">
                        <div id="flashcard" class="card w-full h-full relative">
                            <div class="card-face absolute w-full h-full flex flex-col justify-center items-center p-6 rounded-lg shadow-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
                                <p class="text-3xl text-center">${card.term}</p>
                                ${card.imageUrl ? `<img src="${card.imageUrl}" class="max-h-32 mt-4 rounded">` : ''}
                                <button class="tts-btn absolute top-4 right-4 text-xl text-blue-500"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="card-face card-face-back absolute w-full h-full flex justify-center items-center p-6 rounded-lg shadow-lg bg-gray-100 dark:bg-gray-600 border border-gray-200 dark:border-gray-500">
                                <p class="text-3xl text-center">${card.definition}</p>
                                <button class="tts-btn absolute top-4 right-4 text-xl text-blue-500"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="flip-card-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg text-lg">翻转</button>
                    </div>
                    <div id="srs-buttons" class="hidden mt-6 grid grid-cols-4 gap-4">
                        <button data-rating="1" class="srs-btn srs-btn-again text-white font-bold py-3 px-4 rounded-lg">重来</button>
                        <button data-rating="2" class="srs-btn srs-btn-hard text-white font-bold py-3 px-4 rounded-lg">困难</button>
                        <button data-rating="3" class="srs-btn srs-btn-good text-white font-bold py-3 px-4 rounded-lg">一般</button>
                        <button data-rating="4" class="srs-btn srs-btn-easy text-white font-bold py-3 px-4 rounded-lg">简单</button>
                    </div>
                </div>`;
            
            const flipBtn = document.getElementById('flip-card-btn');
            flipBtn.addEventListener('click', () => {
                document.getElementById('flashcard').classList.add('is-flipped');
                flipBtn.classList.add('hidden');
                document.getElementById('srs-buttons').classList.remove('hidden');
            });
            
            document.querySelectorAll('.srs-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    updateSrsData(card, parseInt(e.currentTarget.dataset.rating));
                    currentCardIndex++;
                    showFlashcard();
                });
            });

            document.querySelectorAll('.tts-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    speakText(e.currentTarget.closest('.card-face').querySelector('p').textContent);
                });
            });
            
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
        }
        
        function renderSpellMode() {
            currentCardIndex = 0;
            showSpellCard();
        }

        function showSpellCard() {
            if (currentCardIndex >= currentSetCards.length) {
                finishStudySession();
                return;
            }
            const card = currentSetCards[currentCardIndex];
            studyPage.innerHTML = `
                <div class="p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${currentCardIndex + 1} / ${currentSetCards.length}</p>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回模式选择</button>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-8 rounded-lg shadow-lg text-center">
                        <p class="text-2xl mb-4">${card.term}</p>
                        ${card.imageUrl ? `<img src="${card.imageUrl}" class="max-h-32 mx-auto mb-4 rounded">` : ''}
                        <button class="tts-btn text-xl text-blue-500 mb-4"><i class="fas fa-volume-up"></i></button>
                        <input id="spell-input" type="text" class="w-full p-3 text-xl border rounded bg-gray-100 dark:bg-gray-600 text-center" placeholder="输入答案...">
                        <button id="check-spell-btn" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">检查</button>
                    </div>
                    <div id="spell-result" class="mt-4 text-center"></div>
                </div>`;
            
            document.getElementById('check-spell-btn').addEventListener('click', checkSpelling);
            document.getElementById('spell-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkSpelling(); });
            document.querySelector('.tts-btn').addEventListener('click', () => speakText(card.term));
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
        }

        function checkSpelling() {
            const input = document.getElementById('spell-input');
            const answer = input.value.trim();
            const card = currentSetCards[currentCardIndex];
            const resultDiv = document.getElementById('spell-result');
            
            if (answer.toLowerCase() === card.definition.toLowerCase()) {
                resultDiv.innerHTML = `<p class="text-green-500 font-bold text-2xl">正确!</p>`;
                input.style.borderColor = 'green';
                updateSrsData(card, 3);
                setTimeout(() => { currentCardIndex++; showSpellCard(); }, 1000);
            } else {
                resultDiv.innerHTML = `<p class="text-red-500 font-bold text-2xl">错误!</p><p class="text-lg mt-2">正确答案: <span class="font-semibold">${card.definition}</span></p>`;
                input.style.borderColor = 'red';
                updateSrsData(card, 1);
                setTimeout(() => { currentSetCards.push(card); currentCardIndex++; showSpellCard(); }, 3000);
            }
            document.getElementById('check-spell-btn').disabled = true;
        }
        
        function renderQuizMode() {
            currentCardIndex = 0;
            showQuizQuestion();
        }

        async function showQuizQuestion() {
            if (currentCardIndex >= currentSetCards.length) {
                finishStudySession();
                return;
            }
            
            const card = currentSetCards[currentCardIndex];
            studyPage.innerHTML = `
                <div class="p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${currentCardIndex + 1} / ${currentSetCards.length}</p>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回模式选择</button>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-8 rounded-lg shadow-lg">
                        <p class="text-2xl mb-6 text-center">${card.term}</p>
                        <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex justify-center items-center col-span-full h-24"><div class="loader"></div><span class="ml-4">AI 正在生成测验选项...</span></div>
                        </div>
                    </div>
                    <div id="quiz-result" class="mt-4 text-center"></div>
                </div>`;
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);

            try {
                const options = await generateQuizOptions(card);
                const optionsContainer = document.getElementById('quiz-options');
                if (optionsContainer) {
                    optionsContainer.innerHTML = options.map(opt => `<button class="quiz-option-btn p-4 border rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-600">${opt}</button>`).join('');
                    document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.addEventListener('click', (e) => checkQuizAnswer(e.target, card)));
                }
            } catch (error) {
                 showToast(`AI 生成选项失败: ${error.message}`, true);
                 const fallbackOptions = generateFallbackQuizOptions(card);
                 const optionsContainer = document.getElementById('quiz-options');
                 if (optionsContainer) {
                    optionsContainer.innerHTML = fallbackOptions.map(opt => `<button class="quiz-option-btn p-4 border rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-600">${opt}</button>`).join('');
                    document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.addEventListener('click', (e) => checkQuizAnswer(e.target, card)));
                 }
            }
        }

        async function generateQuizOptions(correctCard) {
            const prompt = `为多项选择题生成3个看起来合理但错误的干扰选项。问题是'${correctCard.term}'，正确答案是'${correctCard.definition}'。请确保干扰项与正确答案的格式和主题相似。`;
            const schema = {
                type: "OBJECT",
                properties: { distractors: { type: "ARRAY", items: { type: "STRING" } } },
                required: ["distractors"]
            };
            const jsonString = await callGemini(prompt, schema);
            const { distractors } = JSON.parse(jsonString);
            return shuffleArray([correctCard.definition, ...distractors]);
        }
        
        function generateFallbackQuizOptions(correctCard) {
            const wrongOptions = allCardsInCurrentSet.filter(c => c.id !== correctCard.id).map(c => c.definition);
            const options = [correctCard.definition, ...shuffleArray(wrongOptions).slice(0, 3)];
            return shuffleArray(options);
        }

        function checkQuizAnswer(button, card) {
            const answer = button.textContent;
            document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = true);

            if (answer === card.definition) {
                button.classList.add('bg-green-200', 'dark:bg-green-800');
                document.getElementById('quiz-result').innerHTML = `<p class="text-green-500 font-bold text-2xl">正确!</p>`;
                updateSrsData(card, 3);
                setTimeout(() => { currentCardIndex++; showQuizQuestion(); }, 1000);
            } else {
                button.classList.add('bg-red-200', 'dark:bg-red-800');
                document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    if (btn.textContent === card.definition) btn.classList.add('bg-green-200', 'dark:bg-green-800');
                });
                document.getElementById('quiz-result').innerHTML = `<p class="text-red-500 font-bold text-2xl">错误!</p>`;
                updateSrsData(card, 1);
                setTimeout(() => { currentSetCards.push(card); currentCardIndex++; showQuizQuestion(); }, 3000);
            }
        }
        
        function renderMatchMode() {
            const gameCards = shuffleArray(currentSetCards).slice(0, Math.min(6, currentSetCards.length));
            if (gameCards.length < 2) {
                studyPage.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-bold mb-4">无法开始匹配游戏</h2><p>需要至少 2 张卡片才能玩这个游戏。</p><button id="back-to-modes" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回模式选择</button></div>`;
                document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
                return;
            }

            const items = [];
            gameCards.forEach((card, index) => {
                items.push({ content: card.term, matchId: index });
                items.push({ content: card.definition, matchId: index });
            });
            
            studyPage.innerHTML = `
                <div class="p-4 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">匹配游戏</h2>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回模式选择</button>
                    </div>
                    <div id="match-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4">
                        ${shuffleArray(items).map(item => `<div class="match-item h-24 flex justify-center items-center p-2 text-center border-2 rounded-lg cursor-pointer transition-all duration-300 bg-white dark:bg-gray-700" data-match-id="${item.matchId}">${item.content}</div>`).join('')}
                    </div>
                </div>`;
            
            let selectedItem = null;
            document.querySelectorAll('.match-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (item.classList.contains('matched') || selectedItem === item) return;

                    item.classList.add('selected');

                    if (!selectedItem) {
                        selectedItem = item;
                    } else {
                        if (selectedItem.dataset.matchId === item.dataset.matchId) {
                            item.classList.add('matched');
                            selectedItem.classList.add('matched');
                            selectedItem = null;
                            if (document.querySelectorAll('.match-item:not(.matched)').length === 0) {
                                setTimeout(() => { showToast('太棒了，全部匹配成功！'); finishStudySession(); }, 500);
                            }
                        } else {
                            const tempSelectedItem = selectedItem;
                            setTimeout(() => {
                                item.classList.remove('selected');
                                tempSelectedItem.classList.remove('selected');
                            }, 500);
                            selectedItem = null;
                        }
                    }
                });
            });
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
        }

        function finishStudySession() {
            studyPage.innerHTML = `
                <div class="text-center p-8">
                    <h2 class="text-3xl font-bold mb-4">🎉 恭喜你！</h2>
                    <p class="text-xl text-gray-600 dark:text-gray-400">本次学习已完成。</p>
                    <button id="back-to-main-from-finish" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">返回主页</button>
                </div>`;
            document.getElementById('back-to-main-from-finish').addEventListener('click', backToMain);
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ===================================================================================
        // SRS (间隔重复) 逻辑
        // ===================================================================================
        async function updateSrsData(card, rating) {
            if (!currentSetId || !card || !card.id) {
                console.error("无法更新SRS数据：缺少卡组ID或卡片ID。", { currentSetId, cardId: card?.id });
                showToast("发生内部错误，无法保存学习进度。", true);
                return; 
            }

            let { easeFactor = 2.5, interval = 0, repetitions = 0 } = card;
            
            if (rating < 3) {
                repetitions = 0;
                interval = 1;
            } else {
                repetitions += 1;
                if (repetitions === 1) interval = 1;
                else if (repetitions === 2) interval = 6;
                else interval = Math.round(interval * easeFactor);
            }
            
            easeFactor = easeFactor + (0.1 - (5 - rating) * (0.08 + (5 - rating) * 0.02));
            if (easeFactor < 1.3) easeFactor = 1.3;

            const nextReview = new Date();
            nextReview.setDate(nextReview.getDate() + interval);
            
            try {
                const cardRef = doc(db, `sets/${currentSetId}/cards`, card.id);
                await updateDoc(cardRef, { easeFactor, interval, repetitions, nextReview });
                
                const historyRef = collection(db, `users/${currentUser.uid}/history`);
                await addDoc(historyRef, {
                    cardId: card.id,
                    setId: currentSetId,
                    rating: rating,
                    reviewedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("更新SRS数据时出错:", error);
                showToast("保存学习进度失败。", true);
            }
        }

        // ===================================================================================
        // 统计页面逻辑
        // ===================================================================================
        async function showStatsPage(setId) {
            mainPage.classList.add('hidden');
            statsPage.classList.remove('hidden');
            showLoader();
            try {
                const cardsSnapshot = await getDocs(collection(db, `sets/${setId}/cards`));
                const srsStatus = { '新卡片': 0, '学习中': 0, '巩固中': 0, '已掌握': 0 };
                cardsSnapshot.forEach(docSnap => {
                    const card = docSnap.data();
                    if (card.repetitions === 0) srsStatus['新卡片']++;
                    else if (card.interval < 7) srsStatus['学习中']++;
                    else if (card.interval < 30) srsStatus['巩固中']++;
                    else srsStatus['已掌握']++;
                });
                renderSrsStatusChart(srsStatus);

                const historyRef = collection(db, `users/${currentUser.uid}/history`);
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const q = query(historyRef, where("setId", "==", setId), where("reviewedAt", ">=", sevenDaysAgo));
                const historySnapshot = await getDocs(q);
                
                const reviewActivity = {};
                const labels = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    labels.push(key);
                    reviewActivity[key] = 0;
                }
                
                historySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.reviewedAt) {
                         const dateKey = data.reviewedAt.toDate().toISOString().split('T')[0];
                         if (reviewActivity.hasOwnProperty(dateKey)) reviewActivity[dateKey]++;
                    }
                });
                renderReviewActivityChart(reviewActivity, labels);

            } catch (error) {
                console.error("加载统计数据失败:", error);
                showToast('加载统计数据失败', true);
            } finally {
                hideLoader();
            }
            
            document.getElementById('back-to-main-from-stats').addEventListener('click', backToMain);
        }

        function renderSrsStatusChart(data) {
            const ctx = document.getElementById('srs-status-chart').getContext('2d');
            if (srsStatusChart) srsStatusChart.destroy();
            srsStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'SRS 状态',
                        data: Object.values(data),
                        backgroundColor: ['#42A5F5', '#FFA726', '#66BB6A', '#AB47BC'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function renderReviewActivityChart(data, labels) {
            const ctx = document.getElementById('review-activity-chart').getContext('2d');
            if (reviewActivityChart) reviewActivityChart.destroy();
            reviewActivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '每日复习次数',
                        data: labels.map(label => data[label]),
                        backgroundColor: 'rgba(74, 144, 226, 0.6)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // ===================================================================================
        // PWA, 通知, TTS 逻辑
        // ===================================================================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker 注册成功:', reg.scope))
                    .catch(err => console.log('Service Worker 注册失败:', err));
            });
        }
        
        function initNotifications() {
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('通知已启用！');
                    }
                });
            }
        }
        
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                if (/[\u4e00-\u9fa5]/.test(text)) utterance.lang = 'zh-CN';
                else utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                showToast('你的浏览器不支持语音功能。', true);
            }
        }

    </script>
</body>
</html>
