<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—ªå¡ (IntelliFlash) - Gemini AI ç‰ˆ</title>
    <meta name="description" content="ä¸€ä¸ªé›†æˆäº†é—´éš”é‡å¤ã€å¤šç§å­¦ä¹ æ¨¡å¼å’Œç¤¾åŒºå…±äº«çš„å¼ºå¤§é—ªå¡åº”ç”¨ã€‚ç”± Gemini AI é©±åŠ¨ã€‚">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4A90E2/FFFFFF?text=IF">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        /* è‡ªå®šä¹‰æ ·å¼å’ŒåŠ¨ç”» */
        :root {
            --primary-color: #4A90E2;
            --primary-color-dark: #357ABD;
            --background-light: #f7fafc;
            --background-dark: #1a202c;
            --text-light: #2d3748;
            --text-dark: #e2e8f0;
            --card-bg-light: #ffffff;
            --card-bg-dark: #2d3748;
        }
        .dark {
            --background-light: var(--background-dark);
            --text-light: var(--text-dark);
            --card-bg-light: var(--card-bg-dark);
        }
        body {
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg-light);
            transition: background-color 0.3s;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        .srs-btn-again { background-color: #EF5350; }
        .srs-btn-hard { background-color: #FFA726; }
        .srs-btn-good { background-color: #66BB6A; }
        .srs-btn-easy { background-color: #29B6F6; }

        /* åŒ¹é…æ¸¸æˆæ ·å¼ */
        .match-item.selected {
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
        }
        .match-item.matched {
            border-color: #66BB6A;
            background-color: #e8f5e9;
            color: #2e7d32;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s;
        }
        .dark .match-item.matched {
             background-color: #2d3748;
             color: #66BB6A;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-content {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">

    <!-- å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="global-loader" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="loader"></div>
    </div>
    
    <!-- å…¨å±€é€šçŸ¥ -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- å¯¼èˆªæ  -->
        <nav class="py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                <i class="fas fa-brain mr-2"></i>IntelliFlash
            </h1>
            <div>
                <button id="theme-toggle" class="mr-4 text-xl"><i class="fas fa-sun"></i></button>
                <div id="user-info" class="hidden inline-block">
                    <span id="user-email" class="mr-4"></span>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">ç™»å‡º</button>
                </div>
                <div id="auth-buttons" class="inline-block">
                    <button id="login-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">ç™»å½•</button>
                </div>
            </div>
        </nav>

        <!-- ä¸»é¡µé¢ -->
        <main id="main-page">
            <div class="my-6 text-center">
                <button id="create-set-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    <i class="fas fa-plus mr-2"></i>åˆ›å»ºæ–°å¡ç»„
                </button>
                 <button id="public-library-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg text-lg ml-4">
                    <i class="fas fa-globe mr-2"></i>å…¬å¼€å¡ç»„åº“
                </button>
            </div>

            <!-- æˆ‘çš„å¡ç»„ -->
            <section id="my-sets-section">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">æˆ‘çš„å¡ç»„</h2>
                <div id="sets-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- å¡ç»„å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </main>
        
        <!-- å…¬å¼€å¡ç»„åº“é¡µé¢ -->
        <main id="public-library-page" class="hidden">
            <div class="my-6 flex justify-between items-center">
                 <h2 class="text-2xl font-semibold">å…¬å¼€å¡ç»„åº“</h2>
                 <button id="back-to-my-sets-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>è¿”å›æˆ‘çš„å¡ç»„
                </button>
            </div>
            <div class="mb-4">
                <input type="text" id="public-search-input" placeholder="æœç´¢å…¬å¼€å¡ç»„..." class="w-full p-3 rounded-lg border bg-white dark:bg-gray-700">
            </div>
            <div id="public-sets-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- å…¬å¼€å¡ç»„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </main>

        <!-- å­¦ä¹ é¡µé¢ -->
        <div id="study-page" class="hidden">
            <!-- å­¦ä¹ é¡µé¢å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ç»Ÿè®¡é¡µé¢ -->
        <div id="stats-page" class="hidden p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">å­¦ä¹ ç»Ÿè®¡</h2>
                <button id="back-to-main-from-stats" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>è¿”å›
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold mb-2">è®°å¿†æ›²çº¿ (SRS çŠ¶æ€åˆ†å¸ƒ)</h3>
                    <canvas id="srs-status-chart"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">æ¯å‘¨å¤ä¹ æ¬¡æ•°</h3>
                    <canvas id="review-activity-chart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-center">ç™»å½•</h2>
            <!-- é‚®ç®±/å¯†ç è¡¨å• -->
            <form id="email-password-form">
                <input type="email" id="email-input" placeholder="é‚®ç®±" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700" required>
                <input type="password" id="password-input" placeholder="å¯†ç  (è‡³å°‘6ä½)" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700" required>
                <button type="submit" id="email-login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded mb-2">ç™»å½•</button>
                <button type="button" id="email-register-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded">æ³¨å†Œ</button>
            </form>
            <div class="my-4 text-center text-gray-500">æˆ–</div>
            <!-- Google ç™»å½• -->
            <button id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded flex items-center justify-center shadow-sm hover:bg-gray-100 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                <img src="https://www.google.com/favicon.ico" alt="Google" class="w-6 h-6 mr-3">
                ä½¿ç”¨ Google ç™»å½•
            </button>
            <button id="close-auth-modal" class="absolute top-4 right-4 text-2xl text-gray-600 dark:text-gray-400">&times;</button>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘å¡ç»„æ¨¡æ€æ¡† -->
    <div id="set-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col">
            <h2 id="set-modal-title" class="text-2xl font-bold mb-4">åˆ›å»ºæ–°å¡ç»„</h2>
            <form id="set-form" class="flex flex-col flex-grow">
                <input type="hidden" id="set-id-input">
                <input type="text" id="set-title-input" placeholder="å¡ç»„æ ‡é¢˜ï¼Œä¾‹å¦‚â€œé«˜é¢‘è‹±è¯­è¯æ±‡â€" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700" required>
                <textarea id="set-description-input" placeholder="å¡ç»„æè¿°" class="w-full p-3 mb-4 border rounded bg-gray-200 dark:bg-gray-700" rows="2"></textarea>
                
                <div class="flex items-center mb-4">
                    <label for="set-public-checkbox" class="mr-2">å…¬å¼€åˆ†äº«æ­¤å¡ç»„:</label>
                    <input type="checkbox" id="set-public-checkbox" class="h-5 w-5">
                </div>
                
                <!-- AI ç”ŸæˆåŠŸèƒ½ -->
                <div class="bg-blue-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
                    <h3 class="font-semibold mb-2 text-lg text-blue-800 dark:text-blue-300">âœ¨ AI æ™ºèƒ½ç”Ÿæˆå¡ç‰‡</h3>
                    <div class="flex gap-2">
                        <input type="text" id="ai-topic-input" placeholder="è¾“å…¥ä¸»é¢˜ï¼Œå¦‚â€œå¤ªé˜³ç³»è¡Œæ˜Ÿâ€" class="w-full p-2 border rounded bg-white dark:bg-gray-600">
                        <button type="button" id="ai-generate-cards-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded whitespace-nowrap">ç”Ÿæˆå¡ç‰‡</button>
                    </div>
                </div>


                <h3 class="font-semibold mb-2">å¡ç‰‡</h3>
                <div id="cards-container" class="flex-grow overflow-y-auto pr-2">
                    <!-- å¡ç‰‡è¾“å…¥æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="mt-4">
                    <button type="button" id="add-card-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-plus mr-2"></i>æ·»åŠ å¡ç‰‡
                    </button>
                </div>

                <div class="mt-6 flex justify-end">
                    <button type="button" id="cancel-set-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-4">å–æ¶ˆ</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">ä¿å­˜å¡ç»„</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // å¯¼å…¥ Firebase æ¨¡å—ã€‚è¿™äº› URL æ˜¯ Firebase å®˜æ–¹æä¾›çš„ CDNã€‚
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            writeBatch,
            getDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ===================================================================================
        // ğŸ”¥ é…ç½® (é‡è¦!)
        // ===================================================================================
        // è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ è‡ªå·±çš„ Firebase å’Œ Gemini é¡¹ç›®é…ç½®ã€‚
        const firebaseConfig = {
          apiKey: "AIzaSyDyYXFukIb4R16o8mx7cl9ZUzsCO6Y6fro",
          authDomain: "intelliflash-6574c.firebaseapp.com",
          projectId: "intelliflash-6574c",
          storageBucket: "intelliflash-6574c.firebasestorage.app",
          messagingSenderId: "730575240954",
          appId: "1:730575240954:web:d2771d613441f4731cd343",
          measurementId: "G-XFP1RE80XN"
        };
        const GEMINI_API_KEY = "AIzaSyB4kejtqBehPI0Ri1e_huC35-7Gkw7dszk"; // ç•™ç©ºå³å¯ï¼ŒCanvas ä¼šè‡ªåŠ¨æä¾›
        
        // ===================================================================================
        // åˆå§‹åŒ– Firebase
        // ===================================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;
        let srsStatusChart = null;
        let reviewActivityChart = null;

        // ===================================================================================
        // å…¨å±€çŠ¶æ€å’Œ DOM å…ƒç´ 
        // ===================================================================================
        const globalLoader = document.getElementById('global-loader');
        const mainPage = document.getElementById('main-page');
        const studyPage = document.getElementById('study-page');
        const statsPage = document.getElementById('stats-page');
        const publicLibraryPage = document.getElementById('public-library-page');
        const setsContainer = document.getElementById('sets-container');
        const publicSetsContainer = document.getElementById('public-sets-container');
        const toast = document.getElementById('toast-notification');
        
        // ===================================================================================
        // å·¥å…·å‡½æ•°
        // ===================================================================================
        const showLoader = (text = '') => {
            globalLoader.classList.remove('hidden');
            // å¯ä»¥æ·»åŠ æ–‡æœ¬æç¤ºï¼Œä¾‹å¦‚ "AI æ­£åœ¨ç”Ÿæˆ..."
        };
        const hideLoader = () => globalLoader.classList.add('hidden');

        function showToast(message, isError = false) {
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
        
        // ===================================================================================
        // ä¸»é¢˜åˆ‡æ¢
        // ===================================================================================
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const icon = themeToggle.querySelector('i');
            if (document.documentElement.classList.contains('dark')) {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'dark');
            } else {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'light');
            }
        });

        // åˆå§‹åŒ–ä¸»é¢˜
        if (localStorage.getItem('theme') === 'dark' || 
           (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggle.querySelector('i').classList.replace('fa-sun', 'fa-moon');
        }

        // ===================================================================================
        // è®¤è¯é€»è¾‘
        // ===================================================================================
        const authModal = document.getElementById('auth-modal');
        const loginModalBtn = document.getElementById('login-modal-btn');
        const closeAuthModalBtn = document.getElementById('close-auth-modal');
        const authButtons = document.getElementById('auth-buttons');
        const userInfo = document.getElementById('user-info');
        
        loginModalBtn.addEventListener('click', () => authModal.classList.remove('hidden'));
        closeAuthModalBtn.addEventListener('click', () => authModal.classList.add('hidden'));
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.displayName || user.email;
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                authModal.classList.add('hidden');
                loadUserSets();
                initNotifications();
            } else {
                currentUser = null;
                document.getElementById('user-email').textContent = '';
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                setsContainer.innerHTML = '<p class="text-center col-span-full">è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹æˆ–åˆ›å»ºå¡ç»„ã€‚</p>';
            }
        });

        // Google ç™»å½•
        document.getElementById('google-login-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showToast('ç™»å½•æˆåŠŸï¼');
            } catch (error) {
                console.error("Google ç™»å½•å¤±è´¥:", error);
                showToast(`ç™»å½•å¤±è´¥: ${error.message}`, true);
            }
        });

        // é‚®ç®±/å¯†ç ç™»å½•å’Œæ³¨å†Œ
        const emailForm = document.getElementById('email-password-form');
        emailForm.addEventListener('submit', e => e.preventDefault());

        document.getElementById('email-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('ç™»å½•æˆåŠŸï¼');
            } catch (error) {
                console.error("é‚®ç®±ç™»å½•å¤±è´¥:", error);
                showToast(`ç™»å½•å¤±è´¥: ${error.message}`, true);
            }
        });

        document.getElementById('email-register-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•ï¼');
            } catch (error) {
                console.error("æ³¨å†Œå¤±è´¥:", error);
                showToast(`æ³¨å†Œå¤±è´¥: ${error.message}`, true);
            }
        });

        // ç™»å‡º
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('å·²æˆåŠŸç™»å‡ºã€‚');
                mainPage.classList.remove('hidden');
                studyPage.classList.add('hidden');
                statsPage.classList.add('hidden');
                publicLibraryPage.classList.add('hidden');
            } catch (error) {
                console.error("ç™»å‡ºå¤±è´¥:", error);
                showToast(`ç™»å‡ºå¤±è´¥: ${error.message}`, true);
            }
        });
        
        // ===================================================================================
        // Gemini API è°ƒç”¨
        // ===================================================================================
        async function callGemini(prompt, jsonSchema = null) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema,
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("API è¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼");
                }
                return text;
            } catch (error) {
                console.error("è°ƒç”¨ Gemini API æ—¶å‡ºé”™:", error);
                throw error; // Re-throw the error to be caught by the caller
            }
        }

        // ===================================================================================
        // å¡ç»„ CRUD é€»è¾‘ (é›†æˆ AI)
        // ===================================================================================
        const setModal = document.getElementById('set-modal');
        const createSetBtn = document.getElementById('create-set-btn');
        const cancelSetBtn = document.getElementById('cancel-set-btn');
        const addCardBtn = document.getElementById('add-card-btn');
        const setForm = document.getElementById('set-form');
        const cardsContainer = document.getElementById('cards-container');
        const aiGenerateBtn = document.getElementById('ai-generate-cards-btn');

        createSetBtn.addEventListener('click', () => openSetModal());
        cancelSetBtn.addEventListener('click', () => setModal.classList.add('hidden'));

        function openSetModal(set = null) {
            setForm.reset();
            document.getElementById('set-id-input').value = set ? set.id : '';
            document.getElementById('set-modal-title').textContent = set ? 'ç¼–è¾‘å¡ç»„' : 'åˆ›å»ºæ–°å¡ç»„';
            document.getElementById('set-title-input').value = set ? set.title : '';
            document.getElementById('set-description-input').value = set ? set.description : '';
            document.getElementById('set-public-checkbox').checked = set ? set.isPublic : false;
            
            cardsContainer.innerHTML = '';
            if (set && set.cards) {
                set.cards.forEach(card => addCardInputs(card));
            } else {
                addCardInputs(); // æ·»åŠ ä¸€ç»„ç©ºçš„
            }
            setModal.classList.remove('hidden');
        }

        addCardBtn.addEventListener('click', () => addCardInputs());
        
        aiGenerateBtn.addEventListener('click', async () => {
            const topic = document.getElementById('ai-topic-input').value;
            if (!topic) {
                showToast('è¯·è¾“å…¥ä¸€ä¸ªä¸»é¢˜ï¼', true);
                return;
            }
            
            showLoader();
            try {
                const prompt = `ä¸ºä»¥ä¸‹ä¸»é¢˜ç”Ÿæˆä¸€ä¸ªåŒ…å«10ä¸ªæœ¯è¯­å’Œå®šä¹‰çš„é—ªå¡åˆ—è¡¨ï¼š'${topic}'ã€‚è¯·ç¡®ä¿æœ¯è¯­å’Œå®šä¹‰ç®€æ´æ˜äº†ï¼Œé€‚åˆåˆ¶ä½œæˆé—ªå¡ã€‚`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        cards: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    term: { type: "STRING" },
                                    definition: { type: "STRING" }
                                },
                                required: ["term", "definition"]
                            }
                        }
                    },
                    required: ["cards"]
                };

                const jsonString = await callGemini(prompt, schema);
                const generatedData = JSON.parse(jsonString);

                if (generatedData.cards && generatedData.cards.length > 0) {
                    // æ¸…ç©ºç°æœ‰ç©ºå¡ç‰‡
                    if (cardsContainer.children.length === 1 && 
                        !cardsContainer.querySelector('.term-input').value && 
                        !cardsContainer.querySelector('.definition-input').value) {
                        cardsContainer.innerHTML = '';
                    }
                    generatedData.cards.forEach(card => addCardInputs(card));
                    showToast('AI å·²æˆåŠŸç”Ÿæˆå¡ç‰‡ï¼');
                } else {
                    showToast('AI æœªèƒ½ç”Ÿæˆå¡ç‰‡ï¼Œè¯·å°è¯•æ›´æ¢ä¸»é¢˜ã€‚', true);
                }

            } catch (error) {
                showToast(`AI ç”Ÿæˆå¤±è´¥: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        });

        function addCardInputs(card = {}) {
            const cardId = card.id || `new_${Date.now()}_${Math.random()}`;
            const cardDiv = document.createElement('div');
            cardDiv.className = 'grid grid-cols-12 gap-2 mb-3 items-center card-input-group';
            cardDiv.dataset.cardId = cardId;
            
            cardDiv.innerHTML = `
                <div class="col-span-5">
                    <textarea placeholder="æ­£é¢" class="w-full p-2 border rounded bg-gray-100 dark:bg-gray-600 term-input" rows="2">${card.term || ''}</textarea>
                </div>
                <div class="col-span-5">
                    <textarea placeholder="èƒŒé¢" class="w-full p-2 border rounded bg-gray-100 dark:bg-gray-600 definition-input" rows="2">${card.definition || ''}</textarea>
                </div>
                <div class="col-span-2 flex items-center justify-around">
                    <label for="image-upload-${cardId}" class="cursor-pointer text-blue-500 hover:text-blue-700">
                        <i class="fas fa-image"></i>
                    </label>
                    <input type="file" id="image-upload-${cardId}" class="hidden image-upload-input" accept="image/*">
                    <img src="${card.imageUrl || ''}" class="w-8 h-8 object-cover ${card.imageUrl ? '' : 'hidden'} image-preview">
                    <button type="button" class="text-red-500 hover:text-red-700 remove-card-btn"><i class="fas fa-trash"></i></button>
                </div>
            `;
            cardsContainer.appendChild(cardDiv);

            cardDiv.querySelector('.remove-card-btn').addEventListener('click', () => cardDiv.remove());
            cardDiv.querySelector('.image-upload-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const preview = cardDiv.querySelector('.image-preview');
                    preview.src = URL.createObjectURL(file);
                    preview.classList.remove('hidden');
                }
            });
        }

        setForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', true);
                return;
            }
            showLoader();

            const setId = document.getElementById('set-id-input').value;
            const setData = {
                title: document.getElementById('set-title-input').value,
                description: document.getElementById('set-description-input').value,
                isPublic: document.getElementById('set-public-checkbox').checked,
                ownerId: currentUser.uid,
                ownerName: currentUser.displayName || currentUser.email,
                updatedAt: serverTimestamp(),
            };

            try {
                let savedSetId = setId;
                if (setId) { // æ›´æ–°
                    const setRef = doc(db, 'sets', setId);
                    await updateDoc(setRef, setData);
                } else { // åˆ›å»º
                    const docRef = await addDoc(collection(db, 'sets'), { ...setData, createdAt: serverTimestamp() });
                    savedSetId = docRef.id;
                }

                // å¤„ç†å¡ç‰‡ (ä¸Šä¼ å›¾ç‰‡ + ä¿å­˜å¡ç‰‡æ•°æ®)
                const cardInputGroups = cardsContainer.querySelectorAll('.card-input-group');
                const batch = writeBatch(db);
                
                for (const group of cardInputGroups) {
                    const term = group.querySelector('.term-input').value;
                    const definition = group.querySelector('.definition-input').value;
                    if (!term || !definition) continue; // è·³è¿‡ç©ºå¡ç‰‡
                    
                    const cardId = group.dataset.cardId;
                    const cardRef = doc(collection(db, `sets/${savedSetId}/cards`), cardId.startsWith('new_') ? undefined : cardId);
                    
                    const cardData = {
                        term,
                        definition,
                        // SRS é»˜è®¤å€¼
                        easeFactor: 2.5,
                        interval: 0,
                        repetitions: 0,
                        nextReview: new Date()
                    };

                    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
                    const imageInput = group.querySelector('.image-upload-input');
                    const imageFile = imageInput.files[0];
                    if (imageFile) {
                        const imageRef = ref(storage, `card-images/${currentUser.uid}/${savedSetId}/${Date.now()}_${imageFile.name}`);
                        const snapshot = await uploadBytes(imageRef, imageFile);
                        cardData.imageUrl = await getDownloadURL(snapshot.ref);
                    } else {
                        cardData.imageUrl = group.querySelector('.image-preview').src || '';
                    }

                    batch.set(cardRef, cardData, { merge: true });
                }
                
                await batch.commit();

                showToast(`å¡ç»„å·²${setId ? 'æ›´æ–°' : 'åˆ›å»º'}ï¼`);
                setModal.classList.add('hidden');
                loadUserSets();
            } catch (error) {
                console.error("ä¿å­˜å¡ç»„å¤±è´¥:", error);
                showToast(`æ“ä½œå¤±è´¥: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        });

        async function deleteSet(setId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç»„å—ï¼Ÿæ‰€æœ‰ç›¸å…³çš„å¡ç‰‡å’Œå­¦ä¹ è¿›åº¦éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚')) return;
            showLoader();
            try {
                // TODO: åˆ é™¤å¡ç‰‡å­é›†åˆå’Œå›¾ç‰‡
                await deleteDoc(doc(db, 'sets', setId));
                showToast('å¡ç»„å·²åˆ é™¤ã€‚');
                loadUserSets();
            } catch (error) {
                console.error("åˆ é™¤å¡ç»„å¤±è´¥:", error);
                showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        async function loadUserSets() {
            if (!currentUser) return;
            showLoader();
            try {
                const q = query(collection(db, 'sets'), where("ownerId", "==", currentUser.uid));
                const querySnapshot = await getDocs(q);
                setsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    setsContainer.innerHTML = '<p class="text-center col-span-full">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å¡ç»„ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å§ï¼</p>';
                }
                for (const docSnap of querySnapshot.docs) {
                    const set = { id: docSnap.id, ...docSnap.data() };
                    const cardsSnapshot = await getDocs(collection(db, `sets/${set.id}/cards`));
                    set.cardCount = cardsSnapshot.size;
                    setsContainer.appendChild(createSetCard(set));
                }
            } catch (error) {
                console.error("åŠ è½½å¡ç»„å¤±è´¥:", error);
                showToast('åŠ è½½å¡ç»„å¤±è´¥', true);
            } finally {
                hideLoader();
            }
        }

        function createSetCard(set, isPublic = false) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex flex-col justify-between';
            
            let buttonsHtml = '';
            if (isPublic) {
                buttonsHtml = `
                    <button class="clone-set-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full">
                        <i class="fas fa-clone mr-2"></i>å…‹éš†åˆ°æˆ‘çš„å¡ç»„
                    </button>
                `;
            } else {
                buttonsHtml = `
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button class="study-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                           <i class="fas fa-book-open mr-2"></i>å­¦ä¹ 
                        </button>
                        <button class="stats-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">
                           <i class="fas fa-chart-line mr-2"></i>ç»Ÿè®¡
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                         <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                           <i class="fas fa-edit mr-2"></i>ç¼–è¾‘
                        </button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                           <i class="fas fa-trash mr-2"></i>åˆ é™¤
                        </button>
                    </div>
                `;
            }

            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-2">${set.title}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">${set.description || 'æ²¡æœ‰æè¿°'}</p>
                    <p class="text-sm text-gray-500">${set.cardCount || 0} å¼ å¡ç‰‡</p>
                    ${isPublic ? `<p class="text-sm text-gray-500 mt-1">åˆ›å»ºè€…: ${set.ownerName || 'åŒ¿å'}</p>` : ''}
                </div>
                <div class="mt-4">
                    ${buttonsHtml}
                </div>
            `;

            if (isPublic) {
                card.querySelector('.clone-set-btn').addEventListener('click', () => cloneSet(set.id));
            } else {
                card.querySelector('.study-btn').addEventListener('click', () => startStudy(set.id));
                card.querySelector('.stats-btn').addEventListener('click', () => showStatsPage(set.id));
                card.querySelector('.edit-btn').addEventListener('click', async () => {
                    const cardsSnapshot = await getDocs(collection(db, `sets/${set.id}/cards`));
                    const cards = cardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    openSetModal({ ...set, cards });
                });
                card.querySelector('.delete-btn').addEventListener('click', () => deleteSet(set.id));
            }
            return card;
        }
        
        // ===================================================================================
        // å…¬å¼€å¡ç»„åº“é€»è¾‘
        // ===================================================================================
        document.getElementById('public-library-btn').addEventListener('click', () => {
            mainPage.classList.add('hidden');
            publicLibraryPage.classList.remove('hidden');
            loadPublicSets();
        });
        
        document.getElementById('back-to-my-sets-btn').addEventListener('click', () => {
            mainPage.classList.remove('hidden');
            publicLibraryPage.classList.add('hidden');
        });
        
        let allPublicSets = [];
        async function loadPublicSets() {
            if (!currentUser) {
                publicSetsContainer.innerHTML = '<p class="text-center col-span-full">è¯·å…ˆç™»å½•ä»¥æµè§ˆå…¬å¼€å¡ç»„åº“ã€‚</p>';
                return;
            }
            showLoader();
            try {
                const q = query(collection(db, 'sets'), where("isPublic", "==", true));
                const querySnapshot = await getDocs(q);
                allPublicSets = [];
                for (const docSnap of querySnapshot.docs) {
                    const set = { id: docSnap.id, ...docSnap.data() };
                    // ä¸åŠ è½½è‡ªå·±çš„å…¬å¼€å¡ç»„
                    if (set.ownerId === currentUser.uid) continue;
                    
                    const cardsSnapshot = await getDocs(collection(db, `sets/${set.id}/cards`));
                    set.cardCount = cardsSnapshot.size;
                    allPublicSets.push(set);
                }
                displayPublicSets(allPublicSets);
            } catch (error) {
                console.error("åŠ è½½å…¬å¼€å¡ç»„å¤±è´¥:", error);
                showToast('åŠ è½½å…¬å¼€å¡ç»„å¤±è´¥', true);
            } finally {
                hideLoader();
            }
        }
        
        function displayPublicSets(sets) {
             publicSetsContainer.innerHTML = '';
             if (sets.length === 0) {
                publicSetsContainer.innerHTML = '<p class="text-center col-span-full">ç›®å‰æ²¡æœ‰å…¬å¼€çš„å¡ç»„ã€‚</p>';
                return;
            }
            sets.forEach(set => {
                publicSetsContainer.appendChild(createSetCard(set, true));
            });
        }
        
        document.getElementById('public-search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredSets = allPublicSets.filter(set => 
                set.title.toLowerCase().includes(searchTerm) || 
                (set.description && set.description.toLowerCase().includes(searchTerm))
            );
            displayPublicSets(filteredSets);
        });
        
        async function cloneSet(setId) {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', true);
                return;
            }
            if (!confirm('ç¡®å®šè¦å…‹éš†è¿™ä¸ªå¡ç»„å—ï¼Ÿå®ƒå°†è¢«å¤åˆ¶åˆ°â€œæˆ‘çš„å¡ç»„â€ä¸­ã€‚')) return;
            showLoader();
            try {
                const originalSetRef = doc(db, 'sets', setId);
                const originalSetSnap = await getDoc(originalSetRef);
                if (!originalSetSnap.exists()) {
                    throw new Error("åŸå§‹å¡ç»„ä¸å­˜åœ¨");
                }
                const originalSetData = originalSetSnap.data();

                // 1. åˆ›å»ºæ–°çš„å¡ç»„
                const newSetData = {
                    title: originalSetData.title,
                    description: originalSetData.description,
                    isPublic: false, // å…‹éš†åé»˜è®¤ä¸ºç§æœ‰
                    ownerId: currentUser.uid,
                    ownerName: currentUser.displayName || currentUser.email,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    clonedFrom: setId,
                };
                const newSetRef = await addDoc(collection(db, 'sets'), newSetData);

                // 2. å¤åˆ¶æ‰€æœ‰å¡ç‰‡
                const originalCardsRef = collection(db, `sets/${setId}/cards`);
                const originalCardsSnap = await getDocs(originalCardsRef);
                const batch = writeBatch(db);

                originalCardsSnap.forEach(cardDoc => {
                    const newCardRef = doc(collection(db, `sets/${newSetRef.id}/cards`));
                    batch.set(newCardRef, cardDoc.data());
                });

                await batch.commit();
                showToast('å¡ç»„å…‹éš†æˆåŠŸï¼');
                loadUserSets(); // åˆ·æ–°æˆ‘çš„å¡ç»„åˆ—è¡¨
            } catch (error) {
                console.error("å…‹éš†å¡ç»„å¤±è´¥:", error);
                showToast(`å…‹éš†å¤±è´¥: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        // ===================================================================================
        // å­¦ä¹ é€»è¾‘ (é›†æˆ AI)
        // ===================================================================================
        let currentSetCards = [];
        let currentCardIndex = 0;
        let currentSetId = null;

        async function startStudy(setId) {
            showLoader();
            try {
                currentSetId = setId;
                const cardsSnapshot = await getDocs(collection(db, `sets/${setId}/cards`));
                const allCardsInSet = cardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (allCardsInSet.length === 0) {
                    showToast('è¿™ä¸ªå¡ç»„é‡Œæ²¡æœ‰å¡ç‰‡ï¼', true);
                    return;
                }
                
                // è¿‡æ»¤å‡ºéœ€è¦å¤ä¹ çš„å¡ç‰‡
                const now = new Date();
                const dueCards = allCardsInSet.filter(card => {
                    const nextReviewDate = card.nextReview.toDate ? card.nextReview.toDate() : new Date(card.nextReview);
                    return nextReviewDate <= now;
                });

                if (dueCards.length === 0) {
                     showToast('å¤ªæ£’äº†ï¼ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å¡ç‰‡ã€‚');
                     return;
                }
                
                currentSetCards = shuffleArray(dueCards); // åªå­¦ä¹ åˆ°æœŸçš„
                currentCardIndex = 0;

                mainPage.classList.add('hidden');
                studyPage.classList.remove('hidden');
                showStudyModeSelection(allCardsInSet); // ä¼ é€’æ‰€æœ‰å¡ç‰‡ç”¨äºç”Ÿæˆå¹²æ‰°é¡¹

            } catch (error) {
                console.error("å¼€å§‹å­¦ä¹ å¤±è´¥:", error);
                showToast(`å¼€å§‹å­¦ä¹ å¤±è´¥: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }

        function showStudyModeSelection(allCards) {
            studyPage.innerHTML = `
                <div class="text-center p-8">
                    <h2 class="text-3xl font-bold mb-2">é€‰æ‹©å­¦ä¹ æ¨¡å¼</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-8">ä»Šå¤©æœ‰ ${currentSetCards.length} å¼ å¡ç‰‡éœ€è¦å¤ä¹ ã€‚</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                        <button data-mode="flashcard" class="study-mode-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-6 px-4 rounded-lg text-xl">
                            <i class="fas fa-clone mr-3"></i>ç¿»å¡å­¦ä¹ 
                        </button>
                        <button data-mode="spell" class="study-mode-btn bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-4 rounded-lg text-xl">
                            <i class="fas fa-keyboard mr-3"></i>æ‹¼å†™
                        </button>
                        <button data-mode="quiz" class="study-mode-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-6 px-4 rounded-lg text-xl">
                            <i class="fas fa-question-circle mr-3"></i>âœ¨ AI å¢å¼ºæµ‹éªŒ
                        </button>
                        <button data-mode="match" class="study-mode-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-6 px-4 rounded-lg text-xl">
                            <i class="fas fa-gamepad mr-3"></i>åŒ¹é…æ¸¸æˆ
                        </button>
                    </div>
                    <button id="back-to-main-from-study" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">è¿”å›</button>
                </div>
            `;
            document.querySelectorAll('.study-mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    switch(mode) {
                        case 'flashcard': renderFlashcardMode(); break;
                        case 'spell': renderSpellMode(); break;
                        case 'quiz': renderQuizMode(allCards); break;
                        case 'match': renderMatchMode(); break;
                    }
                });
            });
            document.getElementById('back-to-main-from-study').addEventListener('click', backToMain);
        }
        
        function backToMain() {
            mainPage.classList.remove('hidden');
            studyPage.classList.add('hidden');
            statsPage.classList.add('hidden');
            publicLibraryPage.classList.add('hidden');
            loadUserSets(); // åˆ·æ–°å¡ç»„ä¿¡æ¯
        }

        // --- ç¿»å¡æ¨¡å¼ ---
        function renderFlashcardMode() {
            currentCardIndex = 0;
            showFlashcard();
        }

        function showFlashcard() {
            if (currentCardIndex >= currentSetCards.length) {
                finishStudySession();
                return;
            }
            const card = currentSetCards[currentCardIndex];
            studyPage.innerHTML = `
                <div class="p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${currentCardIndex + 1} / ${currentSetCards.length}</p>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">è¿”å›æ¨¡å¼é€‰æ‹©</button>
                    </div>
                    <div id="flashcard-container" class="relative w-full h-80 perspective-1000">
                        <div id="flashcard" class="card w-full h-full relative">
                            <div class="card-face absolute w-full h-full flex flex-col justify-center items-center p-6 rounded-lg shadow-lg bg-white dark:bg-gray-700 border">
                                <p class="text-3xl text-center">${card.term}</p>
                                ${card.imageUrl ? `<img src="${card.imageUrl}" class="max-h-32 mt-4 rounded">` : ''}
                                <button class="tts-btn absolute top-4 right-4 text-xl text-blue-500"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <div class="card-face card-face-back absolute w-full h-full flex justify-center items-center p-6 rounded-lg shadow-lg bg-gray-100 dark:bg-gray-600 border">
                                <p class="text-3xl text-center">${card.definition}</p>
                                <button class="tts-btn absolute top-4 right-4 text-xl text-blue-500"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="flip-card-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg text-lg">ç¿»è½¬</button>
                    </div>
                    <div id="srs-buttons" class="hidden mt-6 grid grid-cols-4 gap-4">
                        <button data-rating="1" class="srs-btn srs-btn-again text-white font-bold py-3 px-4 rounded-lg">é‡æ¥ (Again)</button>
                        <button data-rating="2" class="srs-btn srs-btn-hard text-white font-bold py-3 px-4 rounded-lg">å›°éš¾ (Hard)</button>
                        <button data-rating="3" class="srs-btn srs-btn-good text-white font-bold py-3 px-4 rounded-lg">ä¸€èˆ¬ (Good)</button>
                        <button data-rating="4" class="srs-btn srs-btn-easy text-white font-bold py-3 px-4 rounded-lg">ç®€å• (Easy)</button>
                    </div>
                </div>
            `;
            
            const flashcard = document.getElementById('flashcard');
            const flipBtn = document.getElementById('flip-card-btn');
            
            flipBtn.addEventListener('click', () => {
                flashcard.classList.add('is-flipped');
                flipBtn.classList.add('hidden');
                document.getElementById('srs-buttons').classList.remove('hidden');
            });
            
            document.querySelectorAll('.srs-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const rating = parseInt(e.currentTarget.dataset.rating);
                    updateSrsData(card, rating);
                    currentCardIndex++;
                    showFlashcard();
                });
            });

            document.querySelectorAll('.tts-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const textToSpeak = e.currentTarget.closest('.card-face').querySelector('p').textContent;
                    speakText(textToSpeak);
                });
            });
            
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
        }
        
        // --- æ‹¼å†™æ¨¡å¼ ---
        function renderSpellMode() {
            currentCardIndex = 0;
            showSpellCard();
        }

        function showSpellCard() {
            if (currentCardIndex >= currentSetCards.length) {
                finishStudySession();
                return;
            }
            const card = currentSetCards[currentCardIndex];
            studyPage.innerHTML = `
                <div class="p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${currentCardIndex + 1} / ${currentSetCards.length}</p>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">è¿”å›æ¨¡å¼é€‰æ‹©</button>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-8 rounded-lg shadow-lg text-center">
                        <p class="text-2xl mb-4">${card.term}</p>
                        ${card.imageUrl ? `<img src="${card.imageUrl}" class="max-h-32 mx-auto mb-4 rounded">` : ''}
                        <button class="tts-btn text-xl text-blue-500 mb-4"><i class="fas fa-volume-up"></i></button>
                        <input id="spell-input" type="text" class="w-full p-3 text-xl border rounded bg-gray-100 dark:bg-gray-600 text-center" placeholder="è¾“å…¥ç­”æ¡ˆ...">
                        <button id="check-spell-btn" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">æ£€æŸ¥</button>
                    </div>
                    <div id="spell-result" class="mt-4 text-center"></div>
                </div>
            `;
            
            document.getElementById('check-spell-btn').addEventListener('click', checkSpelling);
            document.getElementById('spell-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkSpelling();
            });
            document.querySelector('.tts-btn').addEventListener('click', () => speakText(card.term));
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
        }

        function checkSpelling() {
            const input = document.getElementById('spell-input');
            const answer = input.value.trim();
            const card = currentSetCards[currentCardIndex];
            const resultDiv = document.getElementById('spell-result');
            
            if (answer.toLowerCase() === card.definition.toLowerCase()) {
                resultDiv.innerHTML = `<p class="text-green-500 font-bold text-2xl">æ­£ç¡®!</p>`;
                input.style.borderColor = 'green';
                updateSrsData(card, 3); // æ­£ç¡®ç®— "Good"
                setTimeout(() => {
                    currentCardIndex++;
                    showSpellCard();
                }, 1000);
            } else {
                resultDiv.innerHTML = `
                    <p class="text-red-500 font-bold text-2xl">é”™è¯¯!</p>
                    <p class="text-lg mt-2">æ­£ç¡®ç­”æ¡ˆ: <span class="font-semibold">${card.definition}</span></p>
                `;
                input.style.borderColor = 'red';
                updateSrsData(card, 1); // é”™è¯¯ç®— "Again"
                setTimeout(() => {
                    // é‡æ–°å­¦ä¹ è¿™å¼ å¡ç‰‡
                    currentSetCards.push(card); 
                    currentCardIndex++;
                    showSpellCard();
                }, 3000);
            }
            document.getElementById('check-spell-btn').disabled = true;
        }
        
        // --- æµ‹éªŒæ¨¡å¼ (AI å¢å¼º) ---
        function renderQuizMode(allCards) {
            currentCardIndex = 0;
            showQuizQuestion(allCards);
        }

        async function showQuizQuestion(allCards) {
            if (currentCardIndex >= currentSetCards.length) {
                finishStudySession();
                return;
            }
            
            const card = currentSetCards[currentCardIndex];
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ŒåŒæ—¶åœ¨åå°ç”Ÿæˆé€‰é¡¹
            studyPage.innerHTML = `
                <div class="p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold">${currentCardIndex + 1} / ${currentSetCards.length}</p>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">è¿”å›æ¨¡å¼é€‰æ‹©</button>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-8 rounded-lg shadow-lg">
                        <p class="text-2xl mb-6 text-center">${card.term}</p>
                        <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex justify-center items-center col-span-full h-24">
                                <div class="loader"></div> <span class="ml-4">AI æ­£åœ¨ç”Ÿæˆæµ‹éªŒé€‰é¡¹...</span>
                            </div>
                        </div>
                    </div>
                    <div id="quiz-result" class="mt-4 text-center"></div>
                </div>
            `;
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);

            try {
                const options = await generateQuizOptions(card, allCards);
                
                // é‡æ–°æ¸²æŸ“é€‰é¡¹éƒ¨åˆ†
                const optionsContainer = document.getElementById('quiz-options');
                if (optionsContainer) {
                    optionsContainer.innerHTML = options.map(opt => `<button class="quiz-option-btn p-4 border rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-600">${opt}</button>`).join('');
                    document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => checkQuizAnswer(e.target, card, allCards));
                    });
                }
            } catch (error) {
                 showToast(`AI ç”Ÿæˆé€‰é¡¹å¤±è´¥: ${error.message}`, true);
                 // å¤±è´¥æ—¶å›é€€åˆ°æ—§ç‰ˆé€»è¾‘
                 const fallbackOptions = generateFallbackQuizOptions(card, allCards);
                 const optionsContainer = document.getElementById('quiz-options');
                 if (optionsContainer) {
                    optionsContainer.innerHTML = fallbackOptions.map(opt => `<button class="quiz-option-btn p-4 border rounded-lg text-left hover:bg-gray-100 dark:hover:bg-gray-600">${opt}</button>`).join('');
                    document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => checkQuizAnswer(e.target, card, allCards));
                    });
                 }
            }
        }

        async function generateQuizOptions(correctCard, allCards) {
            const prompt = `ä¸ºå¤šé¡¹é€‰æ‹©é¢˜ç”Ÿæˆ3ä¸ªçœ‹èµ·æ¥åˆç†ä½†é”™è¯¯çš„å¹²æ‰°é€‰é¡¹ã€‚é—®é¢˜æ˜¯'${correctCard.term}'ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯'${correctCard.definition}'ã€‚è¯·ç¡®ä¿å¹²æ‰°é¡¹ä¸æ­£ç¡®ç­”æ¡ˆçš„æ ¼å¼å’Œä¸»é¢˜ç›¸ä¼¼ã€‚`;
            const schema = {
                type: "OBJECT",
                properties: {
                    distractors: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    }
                },
                required: ["distractors"]
            };

            try {
                const jsonString = await callGemini(prompt, schema);
                const { distractors } = JSON.parse(jsonString);
                const options = [correctCard.definition, ...distractors];
                return shuffleArray(options);
            } catch (e) {
                console.error("AI ç”Ÿæˆå¹²æ‰°é¡¹å¤±è´¥, ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ", e);
                return generateFallbackQuizOptions(correctCard, allCards);
            }
        }
        
        function generateFallbackQuizOptions(correctCard, allCards) {
            let options = [correctCard.definition];
            const wrongOptions = allCards
                .filter(c => c.id !== correctCard.id)
                .map(c => c.definition);
            
            const shuffledWrong = shuffleArray(wrongOptions);
            
            for (let i = 0; i < Math.min(3, shuffledWrong.length); i++) {
                options.push(shuffledWrong[i]);
            }
            
            return shuffleArray(options);
        }

        function checkQuizAnswer(button, card, allCards) {
            const answer = button.textContent;
            const resultDiv = document.getElementById('quiz-result');
            document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = true);

            if (answer === card.definition) {
                button.classList.add('bg-green-200', 'dark:bg-green-800');
                resultDiv.innerHTML = `<p class="text-green-500 font-bold text-2xl">æ­£ç¡®!</p>`;
                updateSrsData(card, 3);
                setTimeout(() => {
                    currentCardIndex++;
                    showQuizQuestion(allCards);
                }, 1000);
            } else {
                button.classList.add('bg-red-200', 'dark:bg-red-800');
                // é«˜äº®æ­£ç¡®ç­”æ¡ˆ
                document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    if (btn.textContent === card.definition) {
                        btn.classList.add('bg-green-200', 'dark:bg-green-800');
                    }
                });
                resultDiv.innerHTML = `
                    <p class="text-red-500 font-bold text-2xl">é”™è¯¯!</p>
                `;
                updateSrsData(card, 1);
                setTimeout(() => {
                    currentSetCards.push(card);
                    currentCardIndex++;
                    showQuizQuestion(allCards);
                }, 3000);
            }
        }
        
        // --- åŒ¹é…æ¸¸æˆæ¨¡å¼ ---
        function renderMatchMode() {
            const gameSize = Math.min(6, Math.floor(currentSetCards.length / 2) * 2);
            if (gameSize < 2) {
                studyPage.innerHTML = `
                    <div class="text-center p-8">
                        <h2 class="text-2xl font-bold mb-4">æ— æ³•å¼€å§‹åŒ¹é…æ¸¸æˆ</h2>
                        <p>éœ€è¦è‡³å°‘ 2 å¼ å¡ç‰‡æ‰èƒ½ç©è¿™ä¸ªæ¸¸æˆã€‚</p>
                        <button id="back-to-modes" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">è¿”å›æ¨¡å¼é€‰æ‹©</button>
                    </div>
                `;
                document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
                return;
            }

            const gameCards = shuffleArray(currentSetCards).slice(0, gameSize);
            const items = [];
            gameCards.forEach((card, index) => {
                items.push({ id: index, content: card.term, matchId: index });
                items.push({ id: index, content: card.definition, matchId: index });
            });

            const shuffledItems = shuffleArray(items);
            
            studyPage.innerHTML = `
                <div class="p-4 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">åŒ¹é…æ¸¸æˆ</h2>
                        <button id="back-to-modes" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">è¿”å›æ¨¡å¼é€‰æ‹©</button>
                    </div>
                    <div id="match-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4">
                        ${shuffledItems.map(item => `
                            <div class="match-item h-24 flex justify-center items-center p-2 text-center border-2 rounded-lg cursor-pointer transition-all duration-300 bg-white dark:bg-gray-700" data-match-id="${item.matchId}">
                                ${item.content}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            let selectedItem = null;
            document.querySelectorAll('.match-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (item.classList.contains('matched')) return;

                    if (!selectedItem) {
                        selectedItem = item;
                        item.classList.add('selected');
                    } else {
                        if (selectedItem === item) {
                            // å–æ¶ˆé€‰æ‹©
                            selectedItem.classList.remove('selected');
                            selectedItem = null;
                        } else if (selectedItem.dataset.matchId === item.dataset.matchId) {
                            // åŒ¹é…æˆåŠŸ
                            item.classList.add('matched');
                            selectedItem.classList.add('matched');
                            selectedItem = null;
                            
                            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if (document.querySelectorAll('.match-item:not(.matched)').length === 0) {
                                setTimeout(() => {
                                    showToast('å¤ªæ£’äº†ï¼Œå…¨éƒ¨åŒ¹é…æˆåŠŸï¼');
                                    finishStudySession();
                                }, 500);
                            }
                        } else {
                            // åŒ¹é…å¤±è´¥
                            item.classList.add('selected');
                            setTimeout(() => {
                                item.classList.remove('selected');
                                selectedItem.classList.remove('selected');
                                selectedItem = null;
                            }, 500);
                        }
                    }
                });
            });
            document.getElementById('back-to-modes').addEventListener('click', showStudyModeSelection);
        }

        function finishStudySession() {
            studyPage.innerHTML = `
                <div class="text-center p-8">
                    <h2 class="text-3xl font-bold mb-4">ğŸ‰ æ­å–œä½ ï¼</h2>
                    <p class="text-xl text-gray-600 dark:text-gray-400">æœ¬æ¬¡å­¦ä¹ å·²å®Œæˆã€‚</p>
                    <button id="back-to-main-from-finish" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">è¿”å›ä¸»é¡µ</button>
                </div>
            `;
            document.getElementById('back-to-main-from-finish').addEventListener('click', backToMain);
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ===================================================================================
        // SRS (é—´éš”é‡å¤) é€»è¾‘
        // ===================================================================================
        async function updateSrsData(card, rating) {
            // ç®€åŒ–çš„ FSRS/SM-2 æ··åˆç®—æ³•
            let { easeFactor, interval, repetitions } = card;
            
            if (rating < 3) { // é”™è¯¯ (Again/Hard)
                repetitions = 0;
                interval = 1; // 1å¤©åå¤ä¹ 
            } else { // æ­£ç¡® (Good/Easy)
                repetitions += 1;
                if (repetitions === 1) {
                    interval = 1;
                } else if (repetitions === 2) {
                    interval = 6;
                } else {
                    interval = Math.round(interval * easeFactor);
                }
            }
            
            // æ›´æ–° ease factor
            easeFactor = easeFactor + (0.1 - (5 - rating) * (0.08 + (5 - rating) * 0.02));
            if (easeFactor < 1.3) easeFactor = 1.3;

            const nextReview = new Date();
            nextReview.setDate(nextReview.getDate() + interval);
            
            const updatedData = {
                easeFactor,
                interval,
                repetitions,
                nextReview
            };
            
            // è®°å½•å­¦ä¹ å†å²
            const historyRef = collection(db, `users/${currentUser.uid}/history`);
            await addDoc(historyRef, {
                cardId: card.id,
                setId: currentSetId,
                rating: rating,
                reviewedAt: serverTimestamp()
            });

            // æ›´æ–° Firestore ä¸­çš„å¡ç‰‡
            const cardRef = doc(db, `sets/${currentSetId}/cards`, card.id);
            await updateDoc(cardRef, updatedData);
        }

        // ===================================================================================
        // ç»Ÿè®¡é¡µé¢é€»è¾‘
        // ===================================================================================
        async function showStatsPage(setId) {
            mainPage.classList.add('hidden');
            statsPage.classList.remove('hidden');
            showLoader();
            try {
                // 1. è·å– SRS çŠ¶æ€åˆ†å¸ƒ
                const cardsSnapshot = await getDocs(collection(db, `sets/${setId}/cards`));
                const srsStatus = { 'æ–°å¡ç‰‡': 0, 'å­¦ä¹ ä¸­': 0, 'å·©å›ºä¸­': 0, 'å·²æŒæ¡': 0 };
                cardsSnapshot.forEach(doc => {
                    const card = doc.data();
                    if (card.repetitions === 0) srsStatus['æ–°å¡ç‰‡']++;
                    else if (card.interval < 7) srsStatus['å­¦ä¹ ä¸­']++;
                    else if (card.interval < 30) srsStatus['å·©å›ºä¸­']++;
                    else srsStatus['å·²æŒæ¡']++;
                });
                renderSrsStatusChart(srsStatus);

                // 2. è·å–æ¯å‘¨å¤ä¹ æ´»åŠ¨
                const historyRef = collection(db, `users/${currentUser.uid}/history`);
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const q = query(historyRef, where("setId", "==", setId), where("reviewedAt", ">=", sevenDaysAgo));
                const historySnapshot = await getDocs(q);
                
                const reviewActivity = {};
                for (let i = 0; i < 7; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    reviewActivity[key] = 0;
                }
                
                historySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.reviewedAt) {
                         const dateKey = data.reviewedAt.toDate().toISOString().split('T')[0];
                         if (reviewActivity.hasOwnProperty(dateKey)) {
                             reviewActivity[dateKey]++;
                         }
                    }
                });
                renderReviewActivityChart(reviewActivity);

            } catch (error) {
                console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
                showToast('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', true);
            } finally {
                hideLoader();
            }
            
            document.getElementById('back-to-main-from-stats').addEventListener('click', backToMain);
        }

        function renderSrsStatusChart(data) {
            const ctx = document.getElementById('srs-status-chart').getContext('2d');
            if (srsStatusChart) srsStatusChart.destroy();
            srsStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'SRS çŠ¶æ€',
                        data: Object.values(data),
                        backgroundColor: ['#42A5F5', '#FFA726', '#66BB6A', '#AB47BC'],
                    }]
                }
            });
        }
        
        function renderReviewActivityChart(data) {
            const ctx = document.getElementById('review-activity-chart').getContext('2d');
            const labels = Object.keys(data).sort();
            const values = labels.map(label => data[label]);

            if (reviewActivityChart) reviewActivityChart.destroy();
            reviewActivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¯æ—¥å¤ä¹ æ¬¡æ•°',
                        data: values,
                        backgroundColor: 'rgba(74, 144, 226, 0.6)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // ===================================================================================
        // PWA, é€šçŸ¥, TTS é€»è¾‘
        // ===================================================================================
        
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', reg))
                    .catch(err => console.log('Service Worker æ³¨å†Œå¤±è´¥:', err));
            });
        }
        
        // è¯·æ±‚é€šçŸ¥æƒé™
        function initNotifications() {
            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('é€šçŸ¥å·²å¯ç”¨ï¼');
                        scheduleDailyReminder();
                    }
                });
            } else if (Notification.permission === 'granted') {
                scheduleDailyReminder();
            }
        }

        // å®‰æ’æ¯æ—¥å­¦ä¹ æé†’
        async function scheduleDailyReminder() {
            if (!currentUser || !('serviceWorker' in navigator) || !navigator.serviceWorker.ready) return;

            const registration = await navigator.serviceWorker.ready;
            const existingNotifications = await registration.getNotifications({ tag: 'daily-reminder' });
            if (existingNotifications.length > 0) return; // å·²æœ‰æé†’

            const now = new Date();
            let reminderTime = new Date();
            reminderTime.setHours(20, 0, 0, 0); // æ¯å¤©æ™šä¸Š 8 ç‚¹

            if (now > reminderTime) {
                reminderTime.setDate(reminderTime.getDate() + 1);
            }
            
            const timeDiff = reminderTime.getTime() - now.getTime();
            
            setTimeout(() => {
                 registration.showNotification('ä»Šå¤©çš„å­¦ä¹ æ—¶é—´åˆ°äº†ï¼', {
                    body: 'æ‰“å¼€ IntelliFlashï¼Œå·©å›ºä½ çš„è®°å¿†å§ï¼',
                    icon: 'https://placehold.co/192x192/4A90E2/FFFFFF?text=IF',
                    tag: 'daily-reminder'
                });
                // å®‰æ’ä¸‹ä¸€æ¬¡
                setInterval(() => {
                    registration.showNotification('ä»Šå¤©çš„å­¦ä¹ æ—¶é—´åˆ°äº†ï¼', {
                        body: 'æ‰“å¼€ IntelliFlashï¼Œå·©å›ºä½ çš„è®°å¿†å§ï¼',
                        icon: 'https://placehold.co/192x192/4A90E2/FFFFFF?text=IF',
                        tag: 'daily-reminder'
                    });
                }, 24 * 60 * 60 * 1000); // æ¯24å°æ—¶
            }, timeDiff);
        }
        
        // æ–‡å­—è½¬è¯­éŸ³ (TTS)
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                // å°è¯•è‡ªåŠ¨é€‰æ‹©è¯­è¨€
                if (/[\u4e00-\u9fa5]/.test(text)) {
                    utterance.lang = 'zh-CN';
                } else {
                    utterance.lang = 'en-US';
                }
                window.speechSynthesis.speak(utterance);
            } else {
                showToast('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ã€‚', true);
            }
        }

    </script>
    
    <!-- Service Worker å’Œ Manifest çš„å ä½ç¬¦ -->
    <!-- ä½ éœ€è¦åˆ›å»º manifest.json å’Œ sw.js æ–‡ä»¶ -->
    
</body>
</html>
